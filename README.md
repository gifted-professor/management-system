# 客户预警仪表盘系统

> 基于订单数据的智能客户管理和复购预测系统

## 📋 项目概述

这是一个为电商业务设计的客户关系管理（CRM）系统，通过分析历史订单数据，自动识别需要跟进的客户，并提供差异化的促单策略建议。

### 核心价值

- ✅ **提高促单效率**：自动筛选出最有价值的950个客户（从9549人中筛选）
- ✅ **降低无效触达**：过滤掉已流失客户（300天+未复购）和低转化客户
- ✅ **精准策略推荐**：根据客户价值层级和平台特性，提供差异化话术
- ✅ **商品预警**：实时监控低毛利商品和高退货SKU

---

## 🎯 主要功能

### 1. 客户触达优先级排序

**优先分算法**：
```
优先分 = (uplift × 毛利 × (1 - 退货率)) - 触达成本 × 订单权重
```

#### 算法组成
- **uplift**（转化概率）：基于未复购天数与个人/品类周期的比值
- **毛利**：历史订单的平均利润或估算毛利
- **退货率**：加权混合实际退货率与品类期望退货率
- **触达成本**：不同平台的联系成本（微信/小红书/抖音/视频号）
- **订单权重**：置信度衰减（1单=0.3，2单=0.6，3单+=1.0）

#### 筛选策略
- ✅ 排除退货率100%的客户
- ✅ 排除超过预警阈值2倍的客户（基本已流失）
- ✅ 1单客户仅保留上个月新客（7677人→53人）
- ✅ 冷却期过滤（近期已联系的客户不再推送）

---

### 2. 客户价值分层

#### 分层标准
| 价值层级 | 条件 | 人数 | 占比 |
|---------|------|------|------|
| **高价值** | 累计消费>5000 或 (3单+且AOV>500) | 3人 | 0.3% |
| **中价值** | 累计消费2000-5000 或 2单+ | 894人 | 94.1% |
| **低价值** | 其他 | 53人 | 5.6% |

---

### 3. 差异化触达策略

根据**客户价值层级**和**销售平台**，系统自动生成差异化的推荐动作：

#### 微信渠道

**高价值客户** → **1v1专属私聊**
- 长期未复购：【1v1暖场关怀】询问近期需求+新品预览
- 短期未复购：【1v1新品推荐】升级款OneOne模仿教程+买拍测评
- 高价值活跃：【1v1增购建议】同系列搭配+学习电商外卖平台2

**中价值客户** → **小福利唤醒**
- 长期未复购：【小福利唤醒】新品补货通知+限时折扣
- 短期未复购：【小福利唤醒】热卖搭配+小红包
- 消费骤降：【小福利唤醒】体验改进回馈+补偿券

**低价值客户** → **限时秒杀+特价清仓**
- 长期未复购：【限时秒杀】断码清仓+超低价格
- 短期未复购：【特价清仓】库存处理+限时抢购

#### 闲鱼渠道

**统一促销策略**（无论价值层级）
- 老用户回访：生日专属福利+独家款
- 直接送东西：无门槛券+直送
- 限时秒杀：超低折扣+看完下架
- 独家款式：新品限量+朋友圈超低折扣

---

### 4. 三大预警系统

#### 📊 加推SKU（近45天 订单>4 且 退货率<20%）
- 识别高销量、低退货的优质商品
- 按订单数降序排序
- 用于指导库存和推广策略

#### ⚠️ 高退货预警（明细>3，退货率>30%）
- 识别质量问题商品
- 需要内部质量复盘
- 暂缓促单，避免客户流失

#### 🔴 低毛利预警（毛利率<35%，明细>1）✨ 新增
- **共115款商品**需要关注
- 排除代发和样品订单
- 按毛利率升序排列

**最需要处理的商品**：
```
匡威1970S    → -11.1% 毛利（亏损）
匡威双肩包   → 0% 毛利（保本）
FM3348      → 10.7% 毛利
AMV44303    → 10.8% 毛利
```

**处理建议**：
1. 🔴 提高售价
2. 🔴 更换供应商（降低成本）
3. 🔴 或停止销售

---

## 📂 项目结构

```
表格/
├── tech/
│   ├── generate_customer_alerts.py    # 核心分析引擎（2878行）
│   ├── config.json                     # 配置文件
│   ├── pull_feishu_orders.py          # 飞书订单拉取
│   ├── merge_bills.py                  # 账单合并
│   ├── 账单汇总_全部.xlsx              # 数据源（16579条记录）
│   └── 新增账单/                       # 增量订单
├── run_customer_dashboard.command      # 一键运行脚本
├── 客户预警仪表盘.html                 # 可视化仪表盘（8.2MB）
├── 客户预警输出.xlsx                   # Excel报表
└── README.md                           # 本文档
```

---

## 🚀 使用方法

### 方法1：一键运行（推荐）
```bash
./run_customer_dashboard.command
```

### 方法2：手动运行
```bash
# 1. 拉取当月订单
python3 tech/pull_feishu_orders.py

# 2. 合并账单
python3 tech/merge_bills.py

# 3. 生成预警
python3 tech/generate_customer_alerts.py \
  --source tech/账单汇总_全部.xlsx \
  --output 客户预警输出.xlsx \
  --html-output 客户预警仪表盘.html \
  --config tech/config.json
```

---

## ⚙️ 配置说明

### config.json 核心参数

```json
{
  "defaults": {
    "gross_margin": 0.32,              // 默认毛利率32%
    "category_cycle_days": 60,         // 默认复购周期60天
    "expected_return_rate": 0.08,      // 期望退货率8%
    "touch_cost": 6.0,                 // 默认触达成本6元
    "max_estimated_margin": 8000.0,    // 最大毛利封顶
    "max_estimated_uplift": 5.0,       // 最大uplift封顶
    "max_priority_score": 120.0,       // 优先分上限
    "min_priority_score": -40.0,       // 优先分下限
    "uplift_base": 0.6,                // uplift基准值
    "uplift_floor": 0.2,               // uplift下限
    "uplift_ceiling": 2.0              // uplift上限
  },
  
  "orders_dampening": {
    "1": 0.3,      // 1单客户权重30%
    "2": 0.6,      // 2单客户权重60%
    "default": 1.0 // 3单+客户权重100%
  },
  
  "single_order": {
    "enabled": true,
    "mode": "previous_month",  // 只保留上个月的1单新客
    "days": 30
  },
  
  "platform_touch_cost": {
    "小红书": 8.0,
    "抖音": 6.5,
    "视频号": 7.0
  }
}
```

### 品类配置示例

```json
{
  "categories": {
    "羽绒服": {
      "gross_margin": 0.42,          // 毛利率42%
      "category_cycle_days": 180,    // 复购周期180天
      "expected_return_rate": 0.05,  // 期望退货率5%
      "touch_cost": 12.0,            // 触达成本12元
      "max_estimated_margin": 12000.0
    },
    "帽子": {
      "gross_margin": 0.28,
      "category_cycle_days": 35,
      "expected_return_rate": 0.1,
      "touch_cost": 5.0
    }
  }
}
```

---

## 📊 输出说明

### 1. Excel输出（客户预警输出.xlsx）

#### Sheet 1：客户概览（全量9549人）
- 包含所有客户的完整数据
- 用于全局分析和数据查询

#### Sheet 2：触达优先级（筛选后950人）✨ 核心
新增字段：
- **价值层级**：高价值/中价值/低价值
- **推荐动作**：差异化话术建议

其他字段：
- 优先分、姓名、主要平台、手机号
- 最近下单日、风险标签、偏好单品
- 有效订单数、退货率、未复购天数
- 复购周期、品类周期、预警阈值
- 估算Uplift、估算毛利、估算退货率、触达成本

#### Sheet 3：指标说明
- 生成日期、高价值阈值
- 优先分公式、流失预警天数
- 冷却期设置、单单客户策略

### 2. HTML仪表盘（客户预警仪表盘.html）

#### 功能特性
- ✅ 实时筛选（关键词搜索、优先分、价值层级、标签、平台）
- ✅ 列排序（点击表头切换升/降序）
- ✅ 跟进标记（勾选已联系客户，自动保存）
- ✅ 订单明细（点击行查看客户所有订单）
- ✅ 全库单号查询（支持订单号/退货单号搜索）
- ✅ 导出联系记录（CSV格式）

#### 三大预警卡片
1. **加推SKU**：推广重点商品
2. **高退货预警**：质量问题商品
3. **低毛利预警**：定价/成本问题 ✨ 新增

---

## 📈 关键数据指标

### 筛选效果

| 指标 | 优化前 | 优化后 | 改善 |
|------|--------|--------|------|
| 待跟进客户总数 | 1621人 | 950人 | ⬇️ 41.4% |
| 平均未复购天数 | 171天 | 96天 | ⬇️ 43.9% |
| 最大未复购天数 | 400天 | 268天 | ⬇️ 33% |
| 300天+客户 | 255人 (15.7%) | 0人 (0%) | ✅ 全部过滤 |
| 200天+客户 | 533人 (32.9%) | 44人 (4.6%) | ⬇️ 91.7% |

### 客户分布

```
总客户数：9549人
├── 1单客户：7677人 (80.4%) → 仅53人进入待跟进（筛选率0.7%）
├── 2单客户：1221人 (12.8%) → 966人进入待跟进（筛选率79.1%）
└── 3单+客户：651人 (6.8%) → 601人进入待跟进（筛选率92.3%）
```

### 优先分分布

```
≥100分（高优先级）：143人，平均未复购61天
50-99分（中优先级）：114人
<50分（低优先级）：693人，平均未复购99天
```

---

## 🔧 技术实现

### 核心算法

#### 1. 复购周期计算
```python
# 个人复购周期 = (最近下单日 - 首次下单日) / (订单数 - 1)
personal_cycle = (last_order - first_order).days / (orders - 1)
```

#### 2. 流失预警阈值
```python
# 取个人周期、品类周期、默认阈值的最大值
threshold = max(
    personal_cycle * 1.5,      # 个人周期 × 1.5倍
    category_cycle * 1.5,       # 品类周期 × 1.5倍
    default_churn_days          # 默认60天
)
```

#### 3. Uplift估算
```python
ratio = days_since / threshold
uplift = base + max(0, ratio - 1.0)
uplift = max(floor, min(ceiling, uplift))  # 限制在[0.2, 2.0]
```

#### 4. 退货率混合
```python
# 3单以上：70%实际 + 30%期望
if orders >= 3:
    estimated_return_rate = 0.7 * observed + 0.3 * expected

# 1-2单：取实际和期望的最大值（保守估计）
else:
    estimated_return_rate = max(observed, expected)
```

---

## 🎓 最佳实践

### 1. 日常使用流程

**上午**：
1. 运行 `./run_customer_dashboard.command` 生成最新数据
2. 打开 `客户预警仪表盘.html`
3. 筛选"高价值"客户，优先1v1私聊
4. 筛选"中价值"客户，批量发送小福利

**下午**：
5. 勾选已联系客户（自动保存到localStorage）
6. 查看低毛利预警，调整商品定价
7. 导出联系记录（CSV）用于后续分析

### 2. 定价优化建议

发现低毛利商品（<35%）时：
1. **成本分析**：对比同类商品的打款金额
2. **市场调研**：查看竞品定价
3. **决策矩阵**：
   - 毛利<0%：立即下架
   - 毛利0-15%：更换供应商或提价
   - 毛利15-35%：适度提价或优化运营

### 3. 客户分层策略

**高价值客户（3人）**：
- 每周至少1次1v1私聊
- 提供专属折扣和新品预览
- 重点维护长期关系

**中价值客户（894人）**：
- 每月1-2次小福利唤醒
- 新品上架时群发通知
- 逐步培养为高价值客户

**低价值客户（53人）**：
- 参与限时秒杀活动
- 清仓商品优先推送
- 不投入过多精力

---

## 🔄 数据更新频率

| 数据源 | 更新频率 | 说明 |
|--------|---------|------|
| 飞书订单 | 每日 | 自动拉取当月订单 |
| 账单汇总 | 每日 | 合并历史+新增订单 |
| 客户预警 | 按需 | 运行脚本生成最新分析 |
| 联系记录 | 实时 | HTML前端localStorage保存 |

---

## ⚠️ 注意事项

### 1. 数据隐私
- 客户预警仪表盘.html 包含完整客户数据（8.2MB）
- **不要**上传到公网服务器
- 仅在本地或内网使用

### 2. 性能优化
- Excel生成时间：约10-15秒
- HTML生成时间：约5-8秒
- 浏览器打开HTML：首次加载3-5秒

### 3. 数据备份
- 定期备份 `tech/账单汇总_全部.xlsx`
- 保留历史联系记录（CSV导出）
- 配置文件修改前先备份

---

## 🐛 常见问题

### Q1: 为什么某些客户没有出现在待跟进列表？
**A:** 可能原因：
- 未复购天数超过阈值2倍（基本流失）
- 退货率100%（被排除）
- 1单客户且不是上个月新客
- 近期已联系（冷却期过滤）

### Q2: 优先分如何理解？
**A:** 优先分综合考虑：
- **高分**：高转化概率、高毛利、低退货、低成本
- **低分**：低转化概率、低毛利、高退货、高成本
- 建议优先联系≥80分的客户

### Q3: 如何调整筛选策略？
**A:** 修改 `config.json`：
- 提高 `orders_dampening["1"]` 可增加1单客户权重
- 降低 `churn_multiplier` 可缩短流失预警阈值
- 调整 `platform_touch_cost` 改变不同平台的成本估算

### Q4: 低毛利预警为什么没显示？
**A:** 检查：
- 是否有订单数>1的商品？
- 是否有打款金额数据？
- 毛利率是否真的<35%？
- 查看控制台是否有[WARN]提示

### Q5: CLV分数和优先分有什么区别？
**A:** 
- **CLV分数**：客户的长期价值潜力（0-100分）
- **优先分**：当前触达的ROI评估（-40~120分）
- 举例：一个高CLV但刚下单的客户，优先分可能不高（因为时机不对）

### Q6: 为什么有些老客户优先分反而不高？
**A:** 优先分综合考虑时机、成功率、利润和风险。如果客户近期消费下滑、退货率高，即使订单数多，优先分也会受影响。这类客户会标记为"下滑型"，需要特别关注。

---

## 📝 更新日志

### v3.0 (2025-11-12) ✨重大更新

#### 🐛 问题修复
- ✅ **修复毛利计算异常**：部分客户显示7357亿毛利（实为退货单号被误读）
  - 强制按 `毛利 = 收款额 - 打款金额` 计算
  - 毛利范围从异常值→ 22.5~374元正常区间
  - 新增字段别名：`"打款金额"、"打款"、"打款价"`

- ✅ **修复优质客户被低估**：
  - 案例：张一一（14单、2858元）优先分从 19.68 → 39.68
  - 用户池从 499人 → **1644人**（扩大 3.3倍）

#### ✨ 新增功能

**1. CLV生命周期价值评估体系（100分制）**
- 历史价值（40%）：累计消费 + 订单数
- 当前活跃度（30%）：近期活跃 + 消费占比
- 增长潜力（30%）：消费趋势 + 复购稳定性

**2. 客户分类标签**
- **潜力标签**：明星客户（2人）/ 潜力客户（599人）/ 普通客户
- **成长类型**：成长型（213人）/ 稳定型 / 下滑型 / 高潜新客 / 新客型

**3. 优先分加权优化**
- 明星客户：+30分
- 潜力客户：+15分
- 10单以上：+20分（25人）
- 5-9单：+10分

**4. 促单理由口语化** 🗣️

改进前：
> 已超流失阈值(180天>阈值90天) + 高转化潜力(uplift 1.6) + 低退货风险 + 中价值客户(￥2058) + 7单老客户

改进后：
> 已180天未买，超过预警线、现在联系成功率高、基本不退货、累计买了2058元、7次老客户

**术语替换对照表**：
| 专业术语 | 口语化表达 |
|---------|-----------|
| 已超流失阈值(X天>阈值Y天) | 已X天未买，超过预警线 |
| 高转化潜力(uplift 1.6) | 现在联系成功率高 |
| 低退货风险 | 基本不退货 |
| 中价值客户(￥2058) | 累计买了2058元 |
| 7单老客户 | 7次老客户 |

**5. 扩大筛选条件（满足任一即纳入）**
- 有风险标签（原有逻辑）
- 明星客户或潜力客户 ✨
- 优先分 ≥ 50 ✨
- 订单数 ≥ 5 ✨
- 成长型/高潜新客 ✨

#### 📊 数据效果

| 指标 | v2.0 | v3.0 | 变化 |
|------|------|------|------|
| 触达名单总数 | 950人 | **1644人** | +73% |
| 明星客户 | 0人 | 2人 | - |
| 潜力客户 | 0人 | **599人** | - |
| 成长型客户 | 0人 | 213人 | - |
| 10单以上老客 | ~10人 | 25人 | +150% |
| 估算毛利范围 | 22.5~8000元 | 22.5~374元 | ✅ 修复 |

#### 🛠️ 技术改进
- 新增函数：`compute_customer_lifecycle_value()`
- 重写函数：`explain_priority_score()` （移除所有专业术语）
- 新增输出字段：`CLV分数`、`成长类型`、`潜力标签`
- 毛利口径说明写入"指标说明"表

---

### v2.0 (2025-11-12)
- ✨ **新增**：客户价值分层（高/中/低）
- ✨ **新增**：差异化触达策略（微信/闲鱼）
- ✨ **新增**：低毛利预警（115款商品）
- 🔧 **优化**：过滤超过阈值2倍的客户
- 🔧 **优化**：1单客户筛选率从全部→0.7%
- 🔧 **优化**：待跟进客户从1621人→950人

### v1.0 (2025-10)
- 初始版本
- 客户优先分排序
- Excel和HTML输出
- 加推SKU和高退货预警

---

## 📞 技术支持

如有问题或建议，请联系开发团队。

---

## 📄 许可证

本项目为内部使用系统，版权所有。

---

**最后更新：2025-11-12**
