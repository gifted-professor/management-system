# 客户优先分 V3.0 计算说明

（文档已归档到 docs/）

本文档记录 `generate_customer_alerts.py` 在 V3.0 中新增的参数、信号计算方式与配置策略，便于日后调优和对外说明。

## 1. 数据输入
- **历史账单**：脚本读取合并后的 `账单汇总_截至10月前.xlsx`（由 `combine_ledgers.py` 生成）。只有有效订单会参与统计；取消单只计数不参与金额。
- **联系记录**：可选的 `contact_log.xlsx` 用于冷却（Snooze）逻辑，格式为两列 `手机号, 最后联系日期`。7 天内联系过的客户会在动作列表中隐藏。
- **配置文件**：`config.json` 定义毛利、品类周期、触达成本、退货率等参数，可按品类/平台覆写。

## 2. 配置结构（`config.json`）

```json
{
  "defaults": {
    "gross_margin": 0.32,          // 默认毛利率
    "category_cycle_days": 60,     // 默认品类购买周期（天）
    "expected_return_rate": 0.08,  // 默认退货率
    "touch_cost": 6.0,             // 默认触达成本
    "uplift_base": 0.6,            // 超期 uplift 起点
    "uplift_floor": 0.2,           // uplift 下限
    "uplift_ceiling": 2.0          // uplift 上限
  },
  "categories": {
    "羽绒服": {
      "aliases": ["羽绒服", "羽绒衣"],
      "gross_margin": 0.42,
      "category_cycle_days": 180,
      "expected_return_rate": 0.05,
      "touch_cost": 12.0
    }
  },
  "platform_touch_cost": {
    "小红书": 8.0,
    "抖音": 6.5
  }
}
```

- 分类通过 `aliases` 与客户偏好单品匹配；未命中时回退到 defaults。
- 平台触达成本覆盖 `touch_cost`：存在平台设置时优先以平台值为准。
- `uplift_base/floor/ceiling` 控制超期倍数的光滑范围。

## 3. 关键信号计算

### 3.1 个人复购周期与阈值
1. **平均复购周期**：当客户有效订单 ≥ 2 时，优先使用去重后的下单日期计算相邻间隔的平均值；若缺少间隔则退回到 `(最近下单日 - 首次下单日) ÷ (订单数-1)`。结果 ≤ 0 时按 1 天记。
2. **个体流失阈值**：  
   - 取 `平均复购周期 × churn_multiplier`（命令行参数，默认为 1.5）。  
   - 同时计算 `品类周期 × churn_multiplier` 与默认 `churn_days`。  
   - 综合上述候选取最大值作为长周期阈值 `long_term_threshold`。  
   - 短周期阈值为长周期的一半（至少 1 天，若与长周期相等则减 1），用于“短期未复购”打标。

### 3.2 标签打标
- 满足 `long_term_threshold` 的客户将获得 “高价值流失预警”（高价值客户）或 “长期未复购” 标签；介于短期阈值的为 “短期未复购”。
- 近 90 天与前 90 天净收比较，当 `近期 ≤ 前期 × drop_threshold`（默认 0.5）时标记 “消费骤降”。
- 退款金额比 ≥ 30% 或退款次数 ≥ 2 时标记 “退货激增”。
- 命中周年日期（结合 `--anniversary-months` 与 `--anniversary-window`）标记 “节点回访”。
- 高价值但仍在 30 天内复购的客户标记 “高价值活跃”。
- 标签列表驱动后续 SOP 话术。

### 3.3 估算毛利与退货率
- **平均客单价 (AOV)**：`累计净收款 ÷ 有效订单数`。
- **估算毛利**：若历史毛利>0，优先采用 `累计毛利 ÷ 有效订单数`；否则用 `AOV × 品类毛利率`。
- **估算退货率**：
  - 订单数 ≥ 3：`0.7 × 实际退货率 + 0.3 × 品类期望退货率`。
  - 否则取 `max(实际退货率, 品类期望退货率)`，缺乏数据则用品类期望值。
  - 上限封顶 95%，避免极端值。

### 3.4 估算 Uplift
- 使用 `estimate_uplift()`：  
  `days_since / 阈值` 若大于 1 则按超期倍数递增，在 `uplift_floor` 与 `uplift_ceiling` 之间裁剪；缺少数据时回退到 `uplift_base`。

### 3.5 触达成本
- 首选平台触达成本（`platform_touch_cost`），否则使用品类 `touch_cost`，最终落入配置的默认值。

### 3.6 优先分
- 公式：  
  `priority_score = (估算Uplift × 估算毛利 × (1 - 估算退货率)) - 触达成本`
- 结果保留两位小数，另存 `priority_score_raw` 用于排序与表格属性。
- 同时根据得分划分优先级桶：  
  `≥80 → 高`, `50-79 → 中`, `0-49 → 低`, `<0 → 负分`，并映射到表格样式 `priority-high/mid/low/other`。

### 3.7 AOV 趋势
- `aov_trend = 近90天净收款 ÷ 前90天净收款`（若前 90 天为 0 则为空）。用于观察客单价变动，在仪表盘中以 `x` 形式呈现。

## 4. 推荐动作 (SOP)
- 标签驱动的动作表通过 `build_sop_recommendations` 生成。示例：  
  - `退货激增` → `【售后排查】(禁止促单，重点核实退款原因)`  
  - `高价值流失预警` → `【专属福利】(话术：基于{偏好单品}定制复购权益)`  
  - 若标签为空，默认输出 `【常规复购关怀】(话术：结合{偏好单品}与{主要平台}复购场景)`。
- 输出字段 `推荐动作` 即供一线跟进时使用的 SOP 话术。

## 5. 输出字段对照

### 5.1 `客户概览` 新增列
- `平均复购周期(天)`：见 3.1。
- `流失预警阈值(天)`：取个体/品类/默认三者中的最大值。
- `品类周期(天)`：来自配置。
- `估算Uplift`、`估算毛利`、`估算退货率`、`触达成本`：见 3.3~3.5。
- `优先分`：公式见 3.6。

### 5.2 `触达优先级` 新增列
- `优先分`（整数展示，原始值用于排序）。
- `复购周期(天)`、`品类周期(天)`、`预警阈值(天)` 同概览含义。
- `估算Uplift`、`估算毛利`、`估算退货率`、`触达成本` 与 `AOV趋势` 直接透出。

### 5.3 HTML 仪表盘
- 为便于一线浏览，HTML 版“触达优先级”隐藏以下字段：`复购周期(天)`、`品类周期(天)`、`预警阈值(天)`、`估算Uplift`、`估算毛利`、`估算退货率`、`触达成本`、`AOV趋势`（Excel 仍保留）。
- 其余列均带 `data-sort-value`，点击表头可在升/降序之间切换；加载后默认按“优先分”降序。
- 顶部摘要区展示优先分分布、热点标签。
- CSV 导出格式固定为 `手机号,最后联系日期`，与 `contact_log.xlsx` 完全兼容。
- 交互：点击触达表任意客户行，将在底部弹出“订单明细”抽屉，仅展示该客户所有历史行的以下字段：`姓名`、`下单平台`、`货品名`、`付款金额`、`退款类型`、`退款原因`，并支持表头排序。

## 6. 冷却期逻辑
- 如果 `contact_log.xlsx` 存在，脚本在生成触达列表时会对每条记录检查距今天数：
  - 当 `delta_days < cooldown_days`（默认 7）时，该客户从动作列表中剔除并计入 “冷却客户数”。
  - HTML 仪表盘底部会提示当前冷却人数。

## 7. 调参与维护建议
1. **更新配置**：新增品类时，在 `config.json` 的 `categories` 添加条目并提供别名；同平台触达成本类似。保持 JSON 为 UTF-8。
2. **调优倍数**：`--churn-multiplier` 参数可在 `run_customer_dashboard.command` 之外覆盖，适合做 AB 测试。
3. **校准成本**：若实际触达费用随渠道变化，可在 `platform_touch_cost` 中维护；未录入的渠道会回退到 `touch_cost` 默认值。
4. **评估优先分区间**：当前桶划分以 0/50/80 为界，可根据团队资源调整 `bucket_priority_score`。
5. **SOP 动作**：需要新增话术时可在 `build_sop_recommendations` 中扩展映射表，确保标签与动作名称同步维护。

## 8. 运行流程回顾
1. 将最新 `2024年总表.xlsx`、`2025年账单汇总.xlsx` 放在 `tech/` 下（若缺失脚本会继续使用现有汇总）。
2. 双击 `run_customer_dashboard.command`：
   - 自动合并账单并生成 `账单汇总_截至10月前.xlsx`。
   - 调用 `generate_customer_alerts.py`，使用 `config.json` 与默认参数计算优先分、输出 Excel 与 HTML。
3. 前线在 HTML 仪表盘完成跟进后，点击 “导出今日联系记录 (CSV)” 并合入次日要用的 `contact_log.xlsx`。

如需进一步调试，可使用：  
`python3 generate_customer_alerts.py --source tech/账单汇总_截至10月前.xlsx --sheet 汇总(截至10月前) --config tech/config.json --output tmp.xlsx --html-output tmp.html`

确保任何对公式或参数的调整，都同步更新本文档与配置文件，方便团队成员理解最新的风险判定标准。 

## 9. 表格输出逻辑（Excel 与 HTML）

本节说明最终输出到 Excel（客户概览 / 触达优先级 / 指标说明）与 HTML 仪表盘的数据筛选和排序规则，便于核对与排错。

- 工作簿结构
  - `客户概览`：包含所有“有效下过单”的客户（取消单不计），不额外排序；用于全量复盘与对账。
  - `触达优先级`：基于风险与机会标签筛出的“待触达名单”，附带优先分与行动建议，并进行排序；供一线跟进。
  - `指标说明`：运行参数、阈值、过滤策略与字段解释。

- 客户合并与有效性
  - 合并键：优先 `手机号`；缺失时用 `姓名|地址`；否则回退到 `姓名` 或 `地址`。
  - 有效订单：`状态` 含“取消”或金额≤0 视为取消；若 `退款类型` 标记“取消”也视为取消。这类行仅计入`取消单数`，不参与金额与订单统计。
  - 退款识别：满足任一即计入退款单数——`退款金额>0`，或 `退货状态` 含“退”，或 `退款类型` 含“退”。

- 标签与阈值（驱动是否进入触达名单）
  - “高价值流失预警 / 长期未复购 / 短期未复购” 由个体阈值（个人复购周期×倍数）、品类阈值（品类周期×倍数）与默认 `churn_days` 三者的“最大值”决定。
  - “消费骤降”当 `近90天 ≤ 前90天 × drop_threshold`（默认 0.5）。
  - “退货激增”当 `退款金额/净收 ≥ 30%` 或 `退款次数 ≥ 2`。
  - “节点回访”按 `--anniversary-months` 与 `--anniversary-window` 匹配；如指定 `--anniversary-only`，仅保留命中纪念日的客户。

- 触达名单（触达优先级）筛选条件
  1) 必须至少拥有一个标签（上述任一标签命中）。
  2) 冷却期（Snooze）：若提供 `contact_log.xlsx` 且 `手机号` 在近 `--cooldown-days`（默认 7）内出现，则隐藏该客户并计入“今日冷却客户数”。
  3) 退货率过滤：退货率=100% 的客户不进入触达名单（概览页不受此限制）。
  4) 首单策略：当启用 `config.json` 中的 `single_order.enabled` 时，仅在指定范围（上一个自然月或近 N 天）保留“只有 1 单”的客户。
  5) 可选上限：若指定 `--max-action N`，仅保留排序后前 N 名。

- 触达名单排序规则（从高到低）
  1) 优先分（降序，使用未取整的 `priority_score_raw`）
  2) 有效订单数（降序）
  3) 退货率（升序）
  4) 平均客单价 AOV（降序）

- 优先分与分桶
  - 公式：`(估算Uplift × 估算毛利 × (1 - 估算退货率)) - 触达成本`
  - 订单数加权：通过 `orders_dampening` 降低低样本客户的权重。
  - 裁剪：在 `min_priority_score` 与 `max_priority_score` 范围内截断。
  - 分桶：`≥80 高 / 50-79 中 / 0-49 低 / <0 负分`，对应表格类名 `priority-high/mid/low/other`。

- HTML 仪表盘附加逻辑
  - 与 `触达优先级` 列表一致的筛选与排序；新增前端筛选（搜索 / 优先级 / 标签 / 平台）。
  - 行首支持“今日跟进”勾选，状态保存在浏览器本地，可导出 `手机号,最后联系日期` CSV 以合入 `contact_log.xlsx`。
  - 顶部元信息展示当前过滤策略，包括“排除退货率 100% 的客户”。

备注：上述逻辑与 `generate_customer_alerts.py` 主流程保持一致；如调整标签阈值、冷却期或分桶边界，请同步更新本节与“指标说明”页中的文字，避免前后不一致。
