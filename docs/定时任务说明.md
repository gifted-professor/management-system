# 定时任务配置说明

## 功能概述

从现在开始，当你运行 `start_dashboard_server.command`（macOS）或 `start_dashboard_server.bat`（Windows）启动服务器时，系统会自动检测并询问是否需要配置定时任务。

## 工作原理

### 自动化流程

```
启动服务器 → 检测定时任务 → 询问安装 → 自动配置 → 每天早8点运行
```

### 具体执行内容

**定时任务每天早上 8:00 自动执行：**
1. 拉取飞书最新订单数据（如果配置了飞书）
2. 合并 2024/2025 账单数据
3. 生成客户预警 Excel 报表
4. 生成最新的 HTML 仪表盘

**员工无感知自动更新：**
- 员工访问仪表盘链接时，始终看到最新数据
- 不需要手动点击任何按钮

---

## 使用说明

### macOS 系统

**第一次启动时：**
```bash
双击运行 start_dashboard_server.command
```

**会看到提示：**
```
⏰ 定时任务检测
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
当前未配置自动更新定时任务。

是否设置每天早上8点自动生成最新数据？
  - 输入 y 安装（推荐）
  - 输入 n 跳过（需手动运行 run_customer_dashboard.command）

请选择 [y/n]:
```

**输入 `y` 后：**
```
✅ 定时任务安装成功！
   📅 执行时间: 每天早上 8:00
   📝 日志位置: /path/to/project/logs/auto_update.log

   查看定时任务: crontab -l
   删除定时任务: crontab -e (然后删除对应行)
```

**已经配置过的情况：**
```
✅ 定时任务已配置（每天早上8点自动更新）

✅ 服务启动成功！
...
```

---

### Windows 系统

**第一次启动时：**
```
双击运行 start_dashboard_server.bat
（Windows 可能需要管理员权限）
```

**提示与 macOS 类似：**
```
⏰ 定时任务检测
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
当前未配置自动更新定时任务。

是否设置每天早上8点自动生成最新数据？
  - 输入 y 安装（推荐）
  - 输入 n 跳过（需手动运行 run_customer_dashboard.bat）

请选择 [y/n]: y
```

**成功安装：**
```
✅ 定时任务安装成功！
   📅 执行时间: 每天早上 8:00
   📝 日志位置: C:\path\to\project\logs\auto_update.log

   查看定时任务: schtasks /query /tn "客户预警自动更新"
   删除定时任务: schtasks /delete /tn "客户预警自动更新" /f
```

---

## 日志查看

### 日志文件位置

```
项目根目录/logs/auto_update.log
```

### 查看最近的日志

**macOS/Linux:**
```bash
tail -f logs/auto_update.log
```

**Windows:**
```cmd
type logs\auto_update.log
```

### 日志内容示例

```
☁️ 0/2 拉取当月订单（飞书多维表）...
✅ 成功拉取 127 条订单

📦 1/2 合并 2024/2025 账单...
✅ 合并完成

📊 2/2 生成客户预警视图...
✅ 已生成：tech/客户预警输出.xlsx 与 客户预警仪表盘.html
```

---

## 定时任务管理

### 查看已配置的定时任务

**macOS:**
```bash
crontab -l
```

**Windows:**
```cmd
schtasks /query /tn "客户预警自动更新"
```

### 修改执行时间

**macOS:**
```bash
# 编辑定时任务
crontab -e

# 修改时间（示例：改为每天早上9点）
0 9 * * * cd "/path/to/project" && ./run_customer_dashboard.command >> "/path/to/project/logs/auto_update.log" 2>&1
```

**Windows:**
```cmd
# 删除旧任务
schtasks /delete /tn "客户预警自动更新" /f

# 创建新任务（例如改为9点）
schtasks /create /tn "客户预警自动更新" /tr "cmd /c cd /d \"C:\path\to\project\" && run_customer_dashboard.bat >> \"C:\path\to\project\logs\auto_update.log\" 2>&1" /sc daily /st 09:00 /f
```

### 删除定时任务

**macOS:**
```bash
crontab -e
# 然后删除包含 run_customer_dashboard.command 的那一行
```

**Windows:**
```cmd
schtasks /delete /tn "客户预警自动更新" /f
```

---

## 故障排查

### 问题1：定时任务没有执行

**检查步骤：**
1. 确认定时任务已安装（见上方"查看已配置的定时任务"）
2. 检查日志文件是否生成：`logs/auto_update.log`
3. 查看日志内容是否有错误信息

**macOS 特殊问题：**
- 系统可能需要授予 cron 权限
- 打开"系统偏好设置 → 安全性与隐私 → 完全磁盘访问权限"
- 添加 `/usr/sbin/cron`

**Windows 特殊问题：**
- 可能需要管理员权限
- 右键 `start_dashboard_server.bat` → 以管理员身份运行

### 问题2：定时任务执行了但数据没更新

**检查步骤：**
1. 查看日志文件 `logs/auto_update.log`
2. 确认是否有错误信息
3. 手动运行 `run_customer_dashboard.command` 测试

**常见原因：**
- 飞书 Token 过期（需要重新配置 `.env.local`）
- Python 环境问题（检查 `python3` 是否可用）
- 文件权限问题（确保脚本有执行权限）

### 问题3：日志文件太大

**清理日志：**
```bash
# macOS/Linux
> logs/auto_update.log  # 清空日志

# Windows
type nul > logs\auto_update.log
```

**定期清理建议：**
- 每月清理一次
- 或者修改定时任务命令，只保留最近的日志：

**macOS:**
```bash
# 修改为只保留最新100行
0 8 * * * cd "/path/to/project" && ./run_customer_dashboard.command 2>&1 | tail -100 >> "/path/to/project/logs/auto_update.log"
```

---

## 高级配置

### 修改为一天执行多次

**场景：**需要每天早上8点和下午2点各执行一次

**macOS:**
```bash
crontab -e

# 添加两行
0 8 * * * cd "/path/to/project" && ./run_customer_dashboard.command >> "/path/to/project/logs/auto_update.log" 2>&1
0 14 * * * cd "/path/to/project" && ./run_customer_dashboard.command >> "/path/to/project/logs/auto_update.log" 2>&1
```

**Windows:**
```cmd
# 创建第二个任务
schtasks /create /tn "客户预警自动更新-下午" /tr "cmd /c cd /d \"C:\path\to\project\" && run_customer_dashboard.bat >> \"C:\path\to\project\logs\auto_update.log\" 2>&1" /sc daily /st 14:00 /f
```

### 只在工作日执行

**macOS (cron语法):**
```bash
# 分 时 日 月 周（1-5 = 周一到周五）
0 8 * * 1-5 cd "/path/to/project" && ./run_customer_dashboard.command >> "/path/to/project/logs/auto_update.log" 2>&1
```

**Windows:**
```cmd
schtasks /create /tn "客户预警自动更新" /tr "..." /sc weekly /d MON,TUE,WED,THU,FRI /st 08:00 /f
```

---

## 备份与恢复

### 备份定时任务

**macOS:**
```bash
# 备份当前的crontab
crontab -l > ~/crontab_backup_$(date +%Y%m%d).txt
```

**Windows:**
```cmd
# 导出任务为XML
schtasks /query /tn "客户预警自动更新" /xml > 客户预警定时任务.xml
```

### 恢复定时任务

**macOS:**
```bash
# 恢复crontab
crontab ~/crontab_backup_20250101.txt
```

**Windows:**
```cmd
# 从XML导入任务
schtasks /create /xml 客户预警定时任务.xml /tn "客户预警自动更新"
```

---

## 总结

✅ **一次配置，终身自动**
- 首次启动服务器时配置一次即可
- 每天早上8点自动更新数据
- 员工无需手动操作

✅ **日志可追溯**
- 所有执行记录保存在 `logs/auto_update.log`
- 方便排查问题

✅ **灵活可调整**
- 支持修改执行时间
- 支持一天多次执行
- 支持工作日执行

如有问题，请查看日志文件或联系技术支持。
