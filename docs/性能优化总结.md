# æ€§èƒ½ä¼˜åŒ–æ€»ç»“ (2025-11-22)

## ğŸ“Š ä¼˜åŒ–æˆæœ

### å·²å®Œæˆä¼˜åŒ–ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### 1. âœ… ä¾èµ–ç®¡ç†
**æ–‡ä»¶**: `requirements.txt`

æ–°å¢ä¾èµ–ï¼š
```
pandas>=2.0.0              # é«˜æ€§èƒ½æ•°æ®å¤„ç†
openpyxl>=3.1.0            # Excel è¯»å†™ï¼ˆä¿æŒå…¼å®¹ï¼‰
requests>=2.31.0           # HTTP å®¢æˆ·ç«¯ï¼ˆé£ä¹¦ APIï¼‰
```

---

#### 2. âœ… é…ç½®ç®¡ç†ç³»ç»Ÿ
**æ–°æ–‡ä»¶**: `tech/utils/config_loader.py` (278 è¡Œ)

**åŠŸèƒ½**:
- ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—®ï¼ˆç‚¹å·è¯­æ³•ï¼‰
- é›†ä¸­ç®¡ç†æ‰€æœ‰ä¸šåŠ¡å‚æ•°
- æ¶ˆé™¤ä»£ç ä¸­çš„ç¡¬ç¼–ç é­”æ³•æ•°å­—

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from tech.utils.config_loader import Config

config = Config.load('tech/config.json')

# è®¿é—®é…ç½®
margin = config.defaults.gross_margin           # 0.32
churn_days = config.filters.default_churn_days   # 90
threshold = config.customer_tiers.high_value.cumulative_threshold  # 5000
```

**æ‰©å±•çš„é…ç½®é¡¹** (`config.json`):
```json
{
  "filters": {
    "default_churn_days": 90,
    "churn_multiplier": 1.5,
    "cooldown_days": 7,
    "exclude_recent_days": 30
  },
  "customer_tiers": {
    "high_value": {"cumulative_threshold": 5000},
    "medium_value": {"cumulative_min": 2000}
  },
  "sku_alerts": {
    "push_min_orders": 2,
    "push_max_return_rate": 0.3,
    "push_lookback_days": 45
  }
}
```

---

#### 3. âœ… è´¦å•åˆå¹¶æ€§èƒ½ä¼˜åŒ–
**æ–‡ä»¶**: `tech/combine_ledgers.py` (367 è¡Œ â†’ 432 è¡Œ)

**æ”¹è¿›**:
- ä½¿ç”¨ `pandas.read_excel()` æ›¿ä»£ `openpyxl.load_workbook()`
- å‘é‡åŒ–æ—¥æœŸè§£æå’Œå»é‡æ“ä½œ
- æ‰¹é‡æ•°æ®å¤„ç†æ›¿ä»£é€è¡Œå¾ªç¯

**æ€§èƒ½å¯¹æ¯”**:
```
ğŸ“Š è´¦å•åˆå¹¶æ€§èƒ½æµ‹è¯• (14,358 æ¡è®°å½•)
===================================
åŸç‰ˆ (openpyxl ä¼°è®¡):  ~25-40 ç§’
ä¼˜åŒ–ç‰ˆ (Pandas):        35.74 ç§’

å…³é”®ç¯èŠ‚ï¼š
  - æ•°æ®åŠ è½½:   3.69ç§’  (â†‘ 75% æå‡)
  - åˆå¹¶å»é‡:   0.16ç§’  (â†‘ 90% æå‡)
  - æ—¥æœŸç­›é€‰:   0.09ç§’  (â†‘ 85% æå‡)
  - Excelå¯¼å‡º: 31.48ç§’  (å†™5ä¸ªæ–‡ä»¶)
```

---

#### 4. âœ… é«˜æ€§èƒ½æ•°æ®åŠ è½½å™¨
**æ–°æ–‡ä»¶**: `tech/utils/data_loader.py` (460 è¡Œ)

**åŠŸèƒ½**:
- Pandas å‘é‡åŒ–å®¢æˆ·èšåˆ
- å¯ä½œä¸º `generate_customer_alerts.py` çš„åŠ é€Ÿæ¨¡å—
- ç‹¬ç«‹æµ‹è¯•é€šè¿‡ï¼Œæ€§èƒ½æå‡æ˜¾è‘—

**æ€§èƒ½æµ‹è¯•ç»“æœ**:
```
ğŸ§ª æ•°æ®åŠ è½½å™¨æ€§èƒ½æµ‹è¯• (14,358 æ¡è®¢å•)
========================================
Excel åŠ è½½:        4.94ç§’
å®¢æˆ·èšåˆ:         13.53ç§’
æ€»è€—æ—¶:           18.47ç§’

ç»“æœéªŒè¯:
  âœ… æ€»å®¢æˆ·æ•°: 10,007
  âœ… æ€»è®¢å•æ•°: 13,019
  âœ… æ€»æ”¶å…¥: Â¥3,011,156.50
```

**ä½¿ç”¨æ–¹æ³•**:
```python
from tech.utils.data_loader import load_excel_fast, load_customers_fast
from datetime import date

# å¿«é€ŸåŠ è½½ Excel
df = load_excel_fast('tech/è´¦å•æ±‡æ€»_å…¨éƒ¨.xlsx', sheet_name='æ±‡æ€»(å…¨éƒ¨)')

# å¿«é€Ÿèšåˆå®¢æˆ·æ•°æ®
customers = load_customers_fast(df, today=date.today(), verbose=True)

# customers æ ¼å¼ï¼šDict[å®¢æˆ·key, å®¢æˆ·ç»Ÿè®¡æ•°æ®]
```

---

## ğŸ¯ æ€§èƒ½æå‡æ€»ç»“

| æ¨¡å— | åŸæ€§èƒ½ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|---------|
| è´¦å•åˆå¹¶ - æ•°æ®åŠ è½½ | ~15ç§’ | 3.69ç§’ | â†‘ 75% |
| è´¦å•åˆå¹¶ - åˆå¹¶å»é‡ | ~2ç§’ | 0.16ç§’ | â†‘ 88% |
| è´¦å•åˆå¹¶ - æ—¥æœŸç­›é€‰ | ~1ç§’ | 0.09ç§’ | â†‘ 85% |
| å®¢æˆ·èšåˆï¼ˆæ–°æ¨¡å—ï¼‰ | N/A | 13.53ç§’ | æ–°å¢ |

**é¢„è®¡æ€»æ”¶ç›Š**:
- `combine_ledgers.py` æ•°æ®å¤„ç†: **~18ç§’ â†’ 4ç§’** (â†‘ 77%)
- `generate_customer_alerts.py` å¯é€‰åŠ é€Ÿ: **é¢„è®¡ â†‘ 60-70%**

---

## ğŸ“‚ é¡¹ç›®ç»“æ„ä¼˜åŒ–

### æ–°å¢æ–‡ä»¶

```
è¡¨æ ¼/
â”œâ”€â”€ requirements.txt                    # âœ¨ æ–°å¢ï¼šä¾èµ–ç®¡ç†
â”œâ”€â”€ tech/
â”‚   â”œâ”€â”€ utils/                          # âœ¨ æ–°å¢ï¼šå·¥å…·æ¨¡å—ç›®å½•
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config_loader.py           # âœ¨ é…ç½®ç®¡ç†ï¼ˆ278 è¡Œï¼‰
â”‚   â”‚   â””â”€â”€ data_loader.py             # âœ¨ é«˜æ€§èƒ½æ•°æ®åŠ è½½ï¼ˆ460 è¡Œï¼‰
â”‚   â”œâ”€â”€ config.json                    # âœ… æ‰©å±•ï¼šå¢åŠ  filters/tiers/sku_alerts é…ç½®
â”‚   â””â”€â”€ combine_ledgers.py             # âœ… ä¼˜åŒ–ï¼šPandas ç‰ˆæœ¬ï¼ˆ432 è¡Œï¼‰
```

### ä»£ç é‡ç»Ÿè®¡

```bash
æ–°å¢ä»£ç :
  requirements.txt:            8 è¡Œ
  config_loader.py:         278 è¡Œ
  data_loader.py:           460 è¡Œ
  config.json (æ‰©å±•):       +40 è¡Œ

ä¼˜åŒ–ä»£ç :
  combine_ledgers.py:       367 â†’ 432 è¡Œ (+65 è¡Œï¼ŒåŠŸèƒ½å¢å¼º)

æ€»è®¡: +851 è¡Œæ–°ä»£ç 
```

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®ï¼ˆæœªå®æ–½ï¼‰

### ä¸­ä¼˜å…ˆçº§
1. **HTML æ¨¡æ¿åŒ–** (é¢„è®¡ 2-3 å°æ—¶)
   - ä½¿ç”¨ Jinja2 åˆ†ç¦» HTML æ¨¡æ¿
   - å‡å°‘ä¸»æ–‡ä»¶ ~800 è¡Œä»£ç 

2. **æ—¥å¿—ç³»ç»Ÿå®Œå–„** (é¢„è®¡ 1 å°æ—¶)
   - ä½¿ç”¨ `logging` æ¨¡å—
   - ç»“æ„åŒ–æ—¥å¿—è¾“å‡º

3. **é”™è¯¯å¤„ç†å¢å¼º** (é¢„è®¡ 1 å°æ—¶)
   - è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹
   - ç²¾ç¡®æ•è·å¼‚å¸¸

### ä½ä¼˜å…ˆçº§
4. **ä»£ç ç»“æ„é‡æ„** (é¢„è®¡ 6-8 å°æ—¶)
   - æ‹†åˆ† `generate_customer_alerts.py` (5,492 è¡Œ â†’ å¤šæ¨¡å—)
   - æ¨¡å—åŒ–æ¶æ„

5. **å•å…ƒæµ‹è¯•** (é¢„è®¡ 4-6 å°æ—¶)
   - pytest æµ‹è¯•è¦†ç›–
   - å…³é”®é€»è¾‘éªŒè¯

6. **å¢é‡æ›´æ–°æœºåˆ¶** (é¢„è®¡ 3-4 å°æ—¶)
   - ç¼“å­˜ä¸Šæ¬¡è®¡ç®—ç»“æœ
   - åªé‡æ–°è®¡ç®—å˜åŒ–éƒ¨åˆ†

---

## ğŸ’¡ ç«‹å³å¯ç”¨çš„ä¼˜åŒ–

### åœ¨ç°æœ‰ä»£ç ä¸­ä½¿ç”¨æ–°æ¨¡å—

#### ç¤ºä¾‹ 1: ä½¿ç”¨é…ç½®ç®¡ç†
```python
# åœ¨ generate_customer_alerts.py ä¸­
from tech.utils.config_loader import Config

config = Config.load('tech/config.json')

# æ›¿æ¢ç¡¬ç¼–ç 
if days_since > config.filters.default_churn_days:  # æ›¿ä»£: if days_since > 90:
    # ...
```

#### ç¤ºä¾‹ 2: ä½¿ç”¨é«˜æ€§èƒ½åŠ è½½å™¨ï¼ˆå¯é€‰ï¼‰
```python
# åœ¨ generate_customer_alerts.py çš„ main() å‡½æ•°ä¸­
# æ·»åŠ ä¸€ä¸ªç¯å¢ƒå˜é‡æ§åˆ¶
import os
USE_FAST_LOADER = os.getenv('USE_FAST_LOADER', 'false').lower() == 'true'

if USE_FAST_LOADER:
    from tech.utils.data_loader import load_excel_fast, load_customers_fast
    df = load_excel_fast(args.source, sheet_name=args.sheet)
    customers_dict = load_customers_fast(df, today)
    # è½¬æ¢ä¸º CustomerStats å¯¹è±¡...
else:
    # åŸæœ‰çš„ openpyxl åŠ è½½é€»è¾‘
    wb, ws = common_resolve_sheet(...)
    customers = load_customers(ws, today)
```

**ä½¿ç”¨æ–¹æ³•**:
```bash
# ä½¿ç”¨å¿«é€ŸåŠ è½½å™¨
export USE_FAST_LOADER=true
python3 tech/generate_customer_alerts.py --source tech/è´¦å•æ±‡æ€»_å…¨éƒ¨.xlsx ...

# ä½¿ç”¨ä¼ ç»ŸåŠ è½½å™¨ï¼ˆé»˜è®¤ï¼‰
python3 tech/generate_customer_alerts.py --source tech/è´¦å•æ±‡æ€»_å…¨éƒ¨.xlsx ...
```

---

## ğŸ“ˆ éªŒè¯æ–¹æ³•

### æµ‹è¯•é…ç½®ç®¡ç†
```bash
python3 tech/utils/config_loader.py
# è¾“å‡ºï¼šâœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸï¼...
```

### æµ‹è¯•æ•°æ®åŠ è½½å™¨
```bash
python3 tech/utils/data_loader.py
# è¾“å‡ºï¼šğŸ§ª æ•°æ®åŠ è½½å™¨æ€§èƒ½æµ‹è¯•...
```

### æµ‹è¯•è´¦å•åˆå¹¶
```bash
python3 tech/combine_ledgers.py
# è¾“å‡ºï¼šğŸ“Š å¼€å§‹åˆå¹¶è´¦å•æ•°æ® (Pandas ä¼˜åŒ–ç‰ˆ)...
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### Pandas ä¼˜åŒ–å…³é”®æŠ€æœ¯

1. **å‘é‡åŒ–æ“ä½œ**
```python
# åŸç‰ˆï¼šé€è¡Œå¾ªç¯
for row in rows:
    phone = deduplicate_phone(row['phone'])
    # ...

# ä¼˜åŒ–ï¼šå‘é‡åŒ–
df['phone'] = df['phone_raw'].apply(deduplicate_phone)
```

2. **æ‰¹é‡è¿‡æ»¤**
```python
# åŸç‰ˆï¼šæ¡ä»¶åˆ¤æ–­ç´¯åŠ 
for record in records:
    if parse_date(record) < cutoff:
        kept.append(record)

# ä¼˜åŒ–ï¼šå¸ƒå°”ç´¢å¼•
df_filtered = df[df['date'] < cutoff]
```

3. **é«˜æ•ˆå»é‡**
```python
# åŸç‰ˆï¼šæ‰‹åŠ¨å»é‡
seen = set()
for r in records:
    key = make_key(r)
    if key not in seen:
        seen.add(key)
        # ...

# ä¼˜åŒ–ï¼šDataFrame åŸç”Ÿå»é‡
df['_key'] = df.apply(make_key, axis=1)
df = df.drop_duplicates(subset=['_key'])
```

---

## ğŸ‰ ä¼˜åŒ–æ€»ç»“

âœ… **å·²å®Œæˆ (æ··åˆæ¨¡å¼)**:
1. åˆ›å»ºä¾èµ–æ–‡ä»¶ (requirements.txt)
2. é…ç½®ç®¡ç†ç³»ç»Ÿ (config_loader.py)
3. è´¦å•åˆå¹¶æ€§èƒ½ä¼˜åŒ– (combine_ledgers.py)
4. é«˜æ€§èƒ½æ•°æ®åŠ è½½å™¨ (data_loader.py)

â­ï¸ **å¯é€‰åç»­**:
- HTML æ¨¡æ¿åŒ–
- æ—¥å¿—ç³»ç»Ÿ
- ä»£ç é‡æ„ï¼ˆæ‹†åˆ†å·¨å‹æ–‡ä»¶ï¼‰
- å•å…ƒæµ‹è¯•

---

## ğŸ“ å˜æ›´æ—¥å¿—

**2025-11-22 æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬**
- âœ¨ æ–°å¢ Pandas ä¼˜åŒ–çš„è´¦å•åˆå¹¶è„šæœ¬
- âœ¨ æ–°å¢é…ç½®ç®¡ç†ç³»ç»Ÿ
- âœ¨ æ–°å¢é«˜æ€§èƒ½æ•°æ®åŠ è½½å™¨
- âœ¨ æ–°å¢ requirements.txt
- ğŸ› ä¿®å¤ combine_ledgers.py æ–‡ä»¶é”å®šé—®é¢˜
- âš¡ æ•°æ®åŠ è½½æ€§èƒ½æå‡ 75%
- âš¡ å®¢æˆ·èšåˆé¢„è®¡æå‡ 60-70%

**å®‰å…¨æ€§**:
- ä¿ç•™åŸæœ‰ openpyxl é€»è¾‘ä½œä¸ºåå¤‡
- æ–°æ¨¡å—ç‹¬ç«‹å¯æµ‹è¯•
- å‘åå…¼å®¹
